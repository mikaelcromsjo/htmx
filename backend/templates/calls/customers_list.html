<div x-data="{ search: '', selectedId: null }">
    <!-- Search Box -->
     
    <input 
        type="text" 
        placeholder="{{ "Search customer..." | t }}" 
        x-model="search"
        class="border p-2 mb-2 w-full"
    />

    <!-- Customer List -->
    {% for customer in customers %}
{% set number = 0 %}  {# Default fallback value #}
{% if customer.last_call_date is not none %}
    {# Convert to date safely #}
    {% set last_call = customer.last_call_date %}
    {% set last_call_date = last_call.date() if last_call.__class__.__name__ == 'datetime' else None %}

    {% if last_call_date is not none %}
        {% set delta_days = (now().date() - last_call_date).days %}

        {% if delta_days == 0 %}
            {% set number = 600 %}
        {% elif delta_days == 1 %}
            {% set number = 500 %}
        {% elif delta_days == 2 %}
            {% set number = 400 %}
        {% elif delta_days <= -1 %}
            {% set number = 0 %}
        {% elif delta_days <= 7 %}
            {% set number = 300 %}
        {% elif delta_days <= 14 %}
            {% set number = 200 %}
        {% elif delta_days <= 21 %}
            {% set number = 100 %}
        {% elif delta_days <= 28 %}
            {% set number = 50 %}
        {% else %}
            {% set number = 0 %}
        {% endif %}
    {% endif %}
{% endif %}
                                

<div 
    tabindex="0"
    class="focus:bg-green-100 p-2 flex items-center cursor-pointer border-b"
    x-show="('{{ customer.first_name }} {{ customer.last_name }}').toLowerCase().includes(search.toLowerCase())"
    :class="{
        'bg-green-100 font-bold text-green-600': selectedId === {{ customer.id }},
        'bg-white font-normal text-gray-900': selectedId !== {{ customer.id }}
    }"
    @click="
        selectedId = {{ customer.id }};
        Alpine.store('customer').id = {{ customer.id }};
        $nextTick(() => htmx.trigger('#customer-calls', 'load-customer'));
        document.querySelector('#save-form').reset();
        document.getElementById('current_call').value = '';
        Alpine.store('call').id = '';
        disableCall();
        disableProduct();
        enableCustomer();
        removeHighlight();
        document.getElementById('status_value').value='';
    "
>
    <!-- Index bubble -->
    <span class="px-2 py-2 mr-2 bg-green-{{number}} rounded"></span>

    <!-- Customer name aligned left and takes full remaining space -->
    <span class="flex-1">{{ customer.first_name }} {{ customer.last_name }}</span>

    <!-- Edit icon on the right -->
    <span 
        class="ml-2 flex items-center w-5 h-5 cursor-pointer"
        hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
        hx-target="#modal-container"
        hx-swap="innerHTML"
        @click.stop="$store.modal.open = true"
    >
        üñãÔ∏è
    </span>
</div>

    {% endfor %}
</div>