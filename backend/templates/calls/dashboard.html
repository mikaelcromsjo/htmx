<input type="hidden" name="customer_id" x-model="Alpine.store('customer').id" id="customer-id">

<div id="customer-calls"
     hx-get="/calls/customer_data"
     hx-include="#customer-id"
     hx-trigger="load-customer"
     hx-swap="none">
</div>

<div class="container-fluid border" style="height: 85vh">

  <!-- Row 1: TopRow -->
  <div id="topRow" class="d-flex border-bottom" style="height:43vh;">
    <!-- Customers Column -->
    <div id="col1" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Customers" | t }}</div>
      <div id="calls-customer-list" class="overflow-auto mt-2" x-data>

        <!-- swap in customer_list.html -->
         {% include '/calls/customers_list.html' %}
      </div>
    </div>

    <!-- Customer Info Column -->
    <div id="col2" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Customer Info" | t }}</div>
      <div class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
        <div id="customer-details">
          <!--Swap in later-->
        </div>
      </div>
    </div>

    <!-- Events Column -->
    <div id="col3" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Events" | t }}</div>
      <div id="call-events" class="overflow-auto mt-2">
        <div id="calls-event-list">
          <div x-data="{ isVisible(event) { let filters = Alpine.store('eventFilters'); if(!filters) return true; return Object.keys(filters).some(type => filters[type] && event[type]); }}">
<div
    id="event-list"
    x-data="{ prevCustomer: null }"
    x-effect="
        console.log('Click Event');
        const currentCustomer = Alpine.store('customer').id;
        if (currentCustomer && currentCustomer !== prevCustomer) {
            prevCustomer = currentCustomer;
            // Find the active event row
            const activeRow = $el.querySelector('.bg-primary.bg-opacity-25');
            if (activeRow) {
                $nextTick(() => { activeRow.click(); });
                console.log('Triggered click on active event row');
            } else {
                console.log('No active event row to click');
            }
        }
    "
>
    {% for event in events %}
    <div
        x-show="{{ 'true' if event.extra_visilble_all else 'false' }} || isVisible({
            filter_a: {{ 'true' if event.type_a else 'false' }},
            filter_b: {{ 'true' if event.type_b else 'false' }},
            filter_c: {{ 'true' if event.type_c else 'false' }},
            filter_d: {{ 'true' if event.type_d else 'false' }},
            filter_e: {{ 'true' if event.type_e else 'false' }}
        })"
        class="p-2 border-bottom cursor-pointer"
        :class="{
            'bg-primary bg-opacity-25 fw-bold text-primary': Alpine.store('event').id === {{ event.id }},
            'bg-white fw-normal text-dark': Alpine.store('event').id !== {{ event.id }}
        }"
        @click="
            Alpine.store('event').id = {{ event.id }};
            enableEvent();
        "
        hx-get="{{ url_for('calls_event_detail', event_id=event.id) }}?list=short"
        hx-target="#event-details"
        hx-swap="innerHTML"
        :hx-vals="JSON.stringify(Alpine.store('customer')?.id ? { customer_id: Alpine.store('customer').id } : {})"
    >
        {{ event.name }}
    </div>
    {% endfor %}
</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Info Column -->
    <div id="col4" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Event Info" | t }}</div>
      <div id="event-details" class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;"></div>
    </div>
  </div>

  <!-- Row 2: BottomRow -->
  <div id="bottomRow" class="d-flex" style="height:43vh;">
    <div id="col5" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      {{ "Calls" | t }}
      <div class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
        <div id="calls">
          {% for call_date in customer_calls %}
          <div class="p-1">{{ call_date | date() }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="col6" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      {{ "Call Info" | t }}
      <div id="call-info" class="overflow-auto mt-2 border p-2"><div style="background:#f8f9fa;"></div></div>
    </div>
<!-- Action Column -->
<div id="col7" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">

  <!-- Filters -->
  <div class="d-flex flex-wrap gap-2 p-2 mb-3 border rounded bg-light">
    <template x-for="(value, type) in Alpine.store('eventFilters')" :key="type">
      <label class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" x-model="Alpine.store('eventFilters')[type]">
        <span
          x-text="{
            filter_a: '{{ 'Parties' | t }}',
            filter_b: '{{ 'AW' | t }}',
            filter_c: '{{ 'Lectures' | t }}',
            filter_d: '{{ 'Activism' | t }}',
            filter_e: '{{ 'Conferences' | t }}'
          }[type] || (type.charAt(0).toUpperCase() + type.slice(1))">
        </span>
      </label>
    </template>

    <label class="form-check form-check-inline">
      <input id="fix" x-model="checked" @change="localStorage.setItem('fix', this.checked);" x-data="{ checked: JSON.parse(localStorage.getItem('fix')) || false }" class="form-check-input" type="checkbox">
      <span>{{ "Fix" | t }}</span>
    </label>
  </div>

  <!-- Save Form -->
  <form id="save-form"
        hx-post="{{ url_for('save_call') }}"
        hx-ext="json-enc"
        hx-swap="none"
        hx-trigger="submit"
        hx-on="htmx:afterRequest:
            document.getElementById('current_call').value =
              JSON.parse(event.detail.xhr.responseText).call_id;
            htmx.trigger('#customer-calls', 'load-customer')">

    <!-- Event Status Options -->
    <div class="d-flex flex-wrap gap-2 p-2 mb-3 border rounded bg-light"
         x-data>
<!--
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Dont know" | t }}</span>
      </label>
      -->
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="1" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Interested" | t }}</span>
      </label>
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="2" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Not interested" | t }}</span>
      </label>
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="3" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Comming" | t }}</span>
      </label>
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="4" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Paid" | t }}</span>
      </label>
      <label class="form-check form-check-inline">
        <input name="event_status" x-model="$store.eventCustomer.status" disabled value="5" class="auto-save event-disable form-check-input" type="radio">
        <span>{{ "Attended" | t }}</span>
      </label>
      <!--hidden-->
      <input name="event_status" x-model="$store.eventCustomer.status" value="0" type="radio" style="display:none">

    </div>

<!-- Call Comment + Status Buttons -->
  <label class="fw-semibold mb-1 d-block w-100">{{ "Call Comment" | t }}</label>
  <textarea name="note" class="auto-save call-disable form-control mb-3 w-100" disabled rows="3"></textarea>

  <input type="hidden" name="status" id="status_value">

  
<div class="d-inline-flex flex-wrap gap-2 align-items-center">
  <button type="button"
          class="auto-save btn btn-success btn-select customer-disable"  disabled
          onclick="document.getElementById('status_value').value='1'; highlightButton(this);enableCall();">
    {{ "Answer" | t }}
  </button>
  <button type="button"
          class="auto-save btn btn-danger btn-select customer-disable"  disabled
          onclick="document.getElementById('status_value').value='2'; highlightButton(this);enableCall();">
    {{ "No answer" | t }}
  </button>

  <button type="button"
          class="customer-disable auto-save btn btn-warning btn-select" disabled
          onclick="document.getElementById('status_value').value='3'; highlightButton(this);enableCall();">
    {{ "Outside Call" | t }}
  </button>

<!-- Hidden alarm modal -->
<div id="alarm_modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-80">
    <h2 class="text-lg font-semibold mb-4">{{ "Set Alarm" | t }}</h2>
    {{ "Note" | t }}
    <textarea id="alarm_note" name="alarm_note" class="form-control mb-3 w-100" rows="3"></textarea>
    
{{ "Date" | t }}
    <input type="datetime-local"
     lang="sv" 
           name="event_alarm_date"
           id="alarm_input"
           class="w-full border rounded-lg p-2 mb-4">
{{ "Reminder" | t }}
<select name="event_alarm_reminder"
        id="alarm_reminder"
        class="w-full border rounded-lg p-2 mb-4">
    <option value="30">{{ "30 minutes before" | t }}</option>
    <option value="60">{{ "1 hour before" | t }}</option>
    <option value="120">{{ "2 hours before" | t }}</option>
    <option value="1440">{{ "1 day before" | t }}</option>
</select>


    <div class="flex justify-end space-x-2">
      <button type="button"
              class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              onclick="document.getElementById('alarm_modal').classList.add('hidden')">
        {{ 'Cancel' | t }}
      </button>
      <button type="submit"
              class="customer-disable px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" disabled
              onclick="document.getElementById('alarm_modal').classList.add('hidden')">
        {{ 'Save' | t }}
      </button>
    </div>
  </div>
</div>

<input type="hidden" name="customer_comment" :value="$store.customer.comment">
<input type="hidden" name="event_id" :value="$store.event.id">
<input type="hidden" name="customer_id" :value="$store.customer.id">
<input type="hidden" name="id" id="current_call">

<div class="relative">
  <button type="button"
          class="customer-disable btn btn-success bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300" disabled
          onclick="showAlarmModal()">
    {{ "Alarm" | t }}
  </button>
</div>


  <button type="submit" class="customer-disable btn btn-success" disabled>
    {{ "Save" | t }}
  </button>
  
</div>
  </form>
</div>
  </div>
</div>

<script>
function autoSaveForm() {
  const form = document.getElementById('save-form');
  if (!form) return;

  const submitForm = () => form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));

  // Auto-submit on any input/select change
  form.querySelectorAll('input.auto-save').forEach(el => {
    el.addEventListener('change', submitForm);
  });

  form.querySelectorAll('button.auto-save').forEach(el => {
    el.addEventListener('click', submitForm);
  });

  // Auto-submit on textarea blur (unfocus)
  form.querySelectorAll('textarea.auto-save').forEach(el => {
    el.addEventListener('blur', submitForm);
  });
}

autoSaveForm();
</script>

<script>
            function enableCall() {
                const buttons = document.querySelectorAll('.call-disable');
                buttons.forEach(button => {
                    button.disabled = false;
                });
            }
            function enableEvent() {
                const buttons = document.querySelectorAll('.event-disable');
                buttons.forEach(button => {
                    button.disabled = false;
                });
            }
            function enableCustomer() {
                const buttons = document.querySelectorAll('.customer-disable');
                buttons.forEach(button => {
                    button.disabled = false;
                });
            }

            function disableCall() {
                const buttons = document.querySelectorAll('.call-disable');
                buttons.forEach(button => {
                    button.disabled = true;
                });
            }

            function disableEvent() {
                const buttons = document.querySelectorAll('.event-disable');
                buttons.forEach(button => {
                    button.disabled = true;
                });
            }

            function disableCustomer() {
                const buttons = document.querySelectorAll('.customer-disable');
                buttons.forEach(button => {
                    button.disabled = true;
                });
            }


          </script>



<script>
const buttons = document.querySelectorAll('.btn-select');
buttons.forEach(btn => {
    btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('highlight'));
        btn.classList.add('highlight');
    });
});

function removeHightlight(){
    buttons.forEach(b => b.classList.remove('highlight'));
}

function highlightButton(button) {
    removeHightlight(); // Remove highlight from all buttons first
    button.classList.add('highlight'); // Add highlight to the clicked or specified button
}


  function showAlarmModal() {
    const modal = document.getElementById("alarm_modal");
    const input = document.getElementById("alarm_input");
    const note = document.getElementById("alarm_note");

        note.value="";
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Format local date/time (not UTC)
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');

        // Combine into local datetime string
        const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        input.value = localDateTime;

    modal.classList.remove("hidden");
  }

</script>

<!-- Include Split.js -->
<script src="https://unpkg.com/split.js/dist/split.min.js"></script>

<script>

// Columns
function setupSplit(ids, key) {
  const saved = JSON.parse(localStorage.getItem(key));
  const defaults = Array(ids.length).fill(100 / ids.length);
  Split(ids.map(id => '#' + id), {
    sizes: saved || defaults,
    gutterSize: 6,
    cursor: 'col-resize',
    minSize: 100,
    onDragEnd: sizes => localStorage.setItem(key, JSON.stringify(sizes))
  });
}

// Rows
function setupRowSplit(ids, key) {
  const saved = JSON.parse(localStorage.getItem(key));
  const defaults = Array(ids.length).fill(100 / ids.length);
  Split(ids.map(id => '#' + id), {
    sizes: saved || defaults,
    direction: 'vertical',
    gutterSize: 6,
    cursor: 'row-resize',
    minSize: 100,
    onDragEnd: sizes => localStorage.setItem(key, JSON.stringify(sizes))
  });
}

// Usage
// Initialize Split.js immediately for static rows
setupSplit(['col1','col2','col3','col4'], 'layout-topRow');
setupSplit(['col5','col6','col7'], 'layout-bottomRow');
setupRowSplit(['topRow', 'bottomRow'], 'row-split');

</script>

<style>
/* Ensure Split.js gutters display */

html, body {
  height: 100%;
  margin: 0;
}

.gutter {
  background-color: #ccc;
}

#topRow,
#bottomRow {
  width: 100%;
  /* required for flex layout */
  display: flex;
  flex-direction: row;
  overflow: auto;
}

/* Needed so Split.js can adjust heights dynamically */
#topRow, #bottomRow, .gutter.gutter-vertical {
  height: calc(50% - 3px); /* initial height guess; Split.js will override */
}

.gutter {
  background: #ddd;
  background-repeat: no-repeat;
  background-position: 50%;
}

.gutter.gutter-vertical {
  cursor: row-resize;
  height: 6px;
}

.gutter.gutter-horizontal {
  cursor: col-resize;
  width: 6px;
}

</style>
