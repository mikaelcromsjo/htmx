
<input type="hidden" name="customer_id" x-model="Alpine.store('customer').id" id="customer-id">
<div id="customer-calls"
     hx-get="/calls/customer_data"
     hx-include="#customer-id"
     hx-trigger="load-customer"
     hx-swap="none">
</div>

<div class="container-fluid border">
    <!-- Row 1 -->
    <div class="row border-bottom" style="min-height: 40vh;">
        <!-- Customers Column -->
        <div class="col-md-3 border-end p-3 d-flex flex-column" style="height:100%;">
            <div class="fw-semibold">{{ "Customers" | t }}</div>
            <div id="calls-customer-list" class="flex-grow-1 overflow-auto mt-2" x-data>
{% for customer in customers %}
<div class="p-2 border-bottom cursor-pointer d-flex justify-content-between align-items-center"
     :class="{
        'bg-success bg-opacity-25 fw-bold text-success': Alpine.store('customer').id=== {{ customer.id }},
        'bg-white fw-normal text-dark': Alpine.store('customer').id !== {{ customer.id }}
     }"
     @click="
        if (Alpine.store('customer').id !== {{ customer.id }}) {
            Alpine.store('customer').id = {{ customer.id }};
            $nextTick(() => htmx.trigger('#customer-calls', 'load-customer'));
            document.querySelector('#save-form').reset(); 
            document.getElementById('current_call').value = '';
            Alpine.store('event').id = '';
            document.getElementById('status_value').value='';
            document.querySelector('#call-fields').disabled = true;
            removeHightlight()    
        }
     "
    hx-swap="none">

  <!-- Customer Name -->
  <span>{{ customer.first_name }} {{ customer.last_name }}</span>

  <!-- Edit Icon -->
<span 
    class="ms-2 cursor-pointer d-flex align-items-center justify-content-center"
    style="width: 20px; height: 20px;"
    hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
    hx-target="#modal-container"
    hx-swap="innerHTML"
    @click.stop="$store.modal.open = true">
    <!-- Pencil SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" color="gray"width="15" height="15" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
      <path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708L4.207 14.793l-3 1a.5.5 0 0 1-.637-.637l1-3L12.146.854zM11.207 2L2 11.207V13h1.793L14 3.793 11.207 2z"/>
    </svg>
</span>

</div>{% endfor %}
            </div>
        </div>

        <!-- Customer Info Column -->
        <div class="col-md-3 border-end p-3 d-flex flex-column" style="height:100%;">
            <div class="fw-semibold">{{ "Customer Info" | t }}</div>

            <div class="flex-grow-1 overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
                <div id="customer-details">
                    {% for info in customer_details %}
                    <div class="p-1">{{ info }}</div>
                    {% endfor %}
                </div>

            </div>

            <div class="mt-2">
                {{ "Comment" | t }}
                <textarea class="form-control mt-1" x-model="Alpine.store('customer').comment" rows="3"></textarea>
                    </textarea>
            </div>
        </div>

        <!-- Events Column -->
        <div class="col-md-3 border-end p-3 d-flex flex-column" style="height:100%;">
            <div class="fw-semibold">{{ "Events" | t }}</div>
            <div id="call-events" class="flex-grow-1 overflow-auto mt-2">
                <div id="calls-event-list">
                    <div x-data="{
                        isVisible(event) {
                            let filters = Alpine.store('eventFilters');
                            if (!filters) return true;
                            return Object.keys(filters).some(type => filters[type] && event[type]);
                        }
                    }">
                        <div id="event-list" x-data>
                            {% for event in events %}
                            <div x-show="isVisible({ 
                                activism: {{ 'true' if event.type_activism else 'false' }},
                                lectures: {{ 'true' if event.type_lectures else 'false' }},
                                parties: {{ 'true' if event.type_parties else 'false' }},
                                politics: {{ 'true' if event.type_politics else 'false' }}
                            })" class="p-2 border-bottom cursor-pointer" :class="{
                                'bg-primary bg-opacity-25 fw-bold text-primary': Alpine.store('event').id === {{ event.id }},
                                'bg-white fw-normal text-dark': Alpine.store('event').id !== {{ event.id }}
                            }" 
                            @click="Alpine.store('event').id = {{ event.id }}"
                                hx-get="{{ url_for('calls_event_detail', event_id=event.id) }}?list=short"
                                hx-target="#event-details"
                                hx-swap="innerHTML"
                                :hx-vals="JSON.stringify(
                                Alpine.store('customer')?.id 
                                    ? { customer_id: Alpine.store('customer').id } 
                                    : {}
                                )">
                                {{ event.name }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Info Column -->
        <div class="col-md-3 border-end p-3 d-flex flex-column" style="height:100%;">
            <div class="fw-semibold">{{ "Event Info" | t }}</div>
            <div id="event-details" class="flex-grow-1 overflow-auto mt-2 p-2 border" style="background:#f8f9fa;"></div>
        </div>
    </div>

    <!-- Row 2 -->
    <div class="row" style="min-height:40vh;">
        <div class="col-md-3 border-end p-3 d-flex flex-column" style="min-height:100%; max-height:400px">
            {{ "Calls" | t }}
            <div class="flex-grow-1 overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
                <div id="calls">
                    {% for call_date in customer_calls %}
                    <div class="p-1">{{ call_date }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-3 border-end p-3 d-flex flex-column" style="height:100%;">
            {{ "Call Info" | t }}
            <div id="call-info">
                <div class="flex-grow-1 overflow-auto mt-2 border p-2" style="background:#f8f9fa;"></div>
            </div>
        </div>

        <div class="col-md-6 border-end p-3 d-flex flex-column" style="height:100%;">
            <!-- Filters -->
            <div class="d-flex flex-wrap gap-2 p-2 mb-3 border rounded bg-light">
<template x-for="(value, type) in Alpine.store('eventFilters')" :key="type">
  <label class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" x-model="Alpine.store('eventFilters')[type]">

    <!-- Translate type names dynamically -->
    <span
      x-text="{
        activism: '{{ "Activism" | t }}',
        lectures: '{{ "Lectures" | t }}',
        parties: '{{ "Parties" | t }}',
        politics: '{{ "Politics" | t }}'
      }[type] || (type.charAt(0).toUpperCase() + type.slice(1))">
    </span>
  </label>
</template>                <label class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox">
                    <span>{{ "Fix" | t }}</span>
                </label>

            </div>
<form id="save-form"
      hx-post="{{ url_for('save_call') }}"
      hx-ext="json-enc"
      hx-swap="none"
    hx-trigger="submit"
    hx-on="htmx:afterRequest:  document.getElementById('current_call').value = JSON.parse(event.detail.xhr.responseText).call_id ;htmx.trigger('#customer-calls', 'load-customer')">      

<!-- Event Options -->
<div class="d-flex flex-wrap gap-2 p-2 mb-3 border rounded bg-light" :key="$store.eventCustomer.status" x-data
 x-effect="
        // force sync with store
        $el.querySelectorAll('input[name=event_status]').forEach(radio => {
            radio.checked = (radio.value == $store.eventCustomer.status)
        })"
        >

    <label class="form-check form-check-inline">
        <input 
            name="event_status" 
            date-save="true" 
            value="1" 
            class="form-check-input" 
            type="radio"
        >
        <span>{{ "Interested" | t }}</span>
    </label>
    <label class="form-check form-check-inline">
        <input 
            name="event_status" 
            date-save="true" 
            value="2" 
            class="form-check-input" 
            type="radio"
        >
        <span>{{ "Not interested" | t }}</span>
    </label>
    <label class="form-check form-check-inline">
        <input 
            name="event_status" 
            date-save="true" 
            value="3" 
            class="form-check-input" 
            type="radio"
        >
        <span>{{ "Paid" | t }}</span>
    </label>

                <!-- Hidden datetime input with Tailwind button trigger -->

<input type="datetime-local" 
       name="event_alarm_date" 
       data-save="true" 
       id="alarm_input"
       class="absolute w-0 h-0 opacity-0 pointer-events-none">

                    <input type="hidden" name="event_id" :value="$store.event.id" x-data>
                    <input type="hidden" name="customer_id" :value="$store.customer.id" x-data>
                    <input type="hidden" name="id" id="current_call">

                <div class="mb-2 relative">

                    <button type="button"
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
                        onclick="document.getElementById('alarm_input').showPicker()">
                        Call Back
                    </button>
                </div>
            </div>

<fieldset id="call-fields" disabled>
    
                {{ "Call Comment" | t }}
                <div>
                    <textarea name="note" date-save="true" class="form-control mb-2" rows="3"></textarea>
                </div>
                <div>

                    <!-- Radio Button Options -->
<form id="statusForm" method="POST">
    <!-- Hidden input to store selected status -->
    <input type="hidden" name="status" id="status_value">

    <div class="d-inline-block me-2 mb-2">
        <!-- Success button -->
        <button 
            type="submit" 
            class="btn btn-success me-2  btn-select"
            onclick="document.getElementById('status_value').value='1';"
        >
            {{ "Answer" | t }}
        </button>

        <button 
            type="submit" 
            class="btn btn-danger me-2 btn-select"
            onclick="document.getElementById('status_value').value='2';"
        >
            {{ "No answer" | t }}
        </button>

        <button 
            type="submit" 
            class="btn btn-warning me-2 btn-select"
            onclick="document.getElementById('status_value').value='3';"
        >
            {{ "Called me" | t }}
        </button>
    </div>
</fieldset>

                    <!-- Save Button -->
                    <button type="submit" class="btn btn-success me-2">{{ "Save" | t }}</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
const buttons = document.querySelectorAll('.btn-select');
buttons.forEach(btn => {
    btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('highlight'));
        btn.classList.add('highlight');
    });
});

function removeHightlight(){
    buttons.forEach(b => b.classList.remove('highlight'));
}

</script>