<input type="hidden" name="customer_id" x-model="Alpine.store('customer').id" id="customer-id">

<div id="customer-calls"
     hx-get="/calls/customer_data"
     hx-include="#customer-id"
     hx-trigger="load-customer"
     hx-swap="none">
</div>

<div class="container-fluid border">

  <!-- Row 1: TopRow -->
  <div id="topRow" class="d-flex border-bottom" style="height:45vh;">
    <!-- Customers Column -->
    <div id="col1" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Customers" | t }}</div>
      <div id="calls-customer-list" class="overflow-auto mt-2" x-data>
        {% for customer in customers %}
        <div class="p-2 border-bottom cursor-pointer d-flex justify-content-between align-items-center"
             :class="{
                'bg-success bg-opacity-25 fw-bold text-success': Alpine.store('customer').id=== {{ customer.id }},
                'bg-white fw-normal text-dark': Alpine.store('customer').id !== {{ customer.id }}
             }"
             @click="
                if (Alpine.store('customer').id !== {{ customer.id }}) {
                    Alpine.store('customer').id = {{ customer.id }};
                    $nextTick(() => htmx.trigger('#customer-calls', 'load-customer'));
                    document.querySelector('#save-form').reset(); 
                    document.getElementById('current_call').value = '';
                    Alpine.store('event').id = '';
                    document.getElementById('status_value').value='';
                    document.querySelector('#call-fields').disabled = true;
                    removeHightlight()    
                }
             "
            hx-swap="none">
          <span>{{ customer.first_name }} {{ customer.last_name }}</span>
          <span class="ms-2 cursor-pointer d-flex align-items-center justify-content-center"
                style="width: 20px; height: 20px;"
                hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                @click.stop="$store.modal.open = true">
            <svg xmlns="http://www.w3.org/2000/svg" color="gray" width="15" height="15" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
              <path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708L4.207 14.793l-3 1a.5.5 0 0 1-.637-.637l1-3L12.146.854zM11.207 2L2 11.207V13h1.793L14 3.793 11.207 2z"/>
            </svg>
          </span>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Customer Info Column -->
    <div id="col2" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Customer Info" | t }}</div>
      <div class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
        <div id="customer-details">
          {% for info in customer_details %}
          <div class="p-1">{{ info }}</div>
          {% endfor %}
        </div>
      </div>
      <div class="mt-2">
        {{ "Comment" | t }}
        <textarea class="form-control mt-1" x-model="Alpine.store('customer').comment" rows="3"></textarea>
      </div>
    </div>

    <!-- Events Column -->
    <div id="col3" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Events" | t }}</div>
      <div id="call-events" class="overflow-auto mt-2">
        <div id="calls-event-list">
          <div x-data="{ isVisible(event) { let filters = Alpine.store('eventFilters'); if(!filters) return true; return Object.keys(filters).some(type => filters[type] && event[type]); }}">
            <div id="event-list" x-data>
              {% for event in events %}
              <div x-show="isVisible({ 
                    activism: {{ 'true' if event.type_activism else 'false' }},
                    lectures: {{ 'true' if event.type_lectures else 'false' }},
                    parties: {{ 'true' if event.type_parties else 'false' }},
                    politics: {{ 'true' if event.type_politics else 'false' }}
                  })"
                  class="p-2 border-bottom cursor-pointer"
                  :class="{
                    'bg-primary bg-opacity-25 fw-bold text-primary': Alpine.store('event').id === {{ event.id }},
                    'bg-white fw-normal text-dark': Alpine.store('event').id !== {{ event.id }}
                  }"
                  @click="Alpine.store('event').id = {{ event.id }}"
                  hx-get="{{ url_for('calls_event_detail', event_id=event.id) }}?list=short"
                  hx-target="#event-details"
                  hx-swap="innerHTML"
                  :hx-vals="JSON.stringify(Alpine.store('customer')?.id ? { customer_id: Alpine.store('customer').id } : {})">
                {{ event.name }}
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Info Column -->
    <div id="col4" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <div class="fw-semibold">{{ "Event Info" | t }}</div>
      <div id="event-details" class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;"></div>
    </div>
  </div>

  <!-- Row 2: BottomRow -->
  <div id="bottomRow" class="d-flex" style="height:45vh;">
    <div id="col5" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      {{ "Calls" | t }}
      <div class="overflow-auto mt-2 p-2 border" style="background:#f8f9fa;">
        <div id="calls">
          {% for call_date in customer_calls %}
          <div class="p-1">{{ call_date }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="col6" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      {{ "Call Info" | t }}
      <div id="call-info" class="overflow-auto mt-2 border p-2"><div style="background:#f8f9fa;"></div></div>
    </div>
    <div id="col7" class="border-end p-3 overflow-auto bg-light" style="flex:0 0 auto;">
      <!-- Actions, filters, forms omitted for brevity but keep structure -->
    </div>
  </div>
</div>

<button class="btn btn-sm btn-outline-secondary mt-2" onclick="localStorage.clear(); location.reload();">
  Reset layout
</button>

<!-- Include Split.js -->
<script src="https://unpkg.com/split.js/dist/split.min.js"></script>

<script>
// Setup Split.js with persistent widths
function setupSplit(ids, key) {
  const saved = JSON.parse(localStorage.getItem(key));
  const defaults = Array(ids.length).fill(100 / ids.length);
  Split(ids.map(id => '#' + id), {
    sizes: saved || defaults,
    gutterSize: 6,
    cursor: 'col-resize',
    minSize: 100,
    onDragEnd: sizes => localStorage.setItem(key, JSON.stringify(sizes))
  });
}

// Initialize Split.js immediately for static rows
setupSplit(['col1','col2','col3','col4'], 'layout-topRow');
setupSplit(['col5','col6','col7'], 'layout-bottomRow');
</script>

<style>
/* Ensure Split.js gutters display */
.gutter {
  background-color: #ccc;
}
</style>
