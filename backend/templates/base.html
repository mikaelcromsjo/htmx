<!DOCTYPE html>
<html lang="en" x-cloak>

<head>
    <meta charset="UTF-8">
    <title>{% block title %}{{ "Dashboard" | t }}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/tailwind.css">


    <!-- HTMX and Alpine.js from /static -->
    <script src="/static/htmx.min.js"></script>
    <script src="/static/alpine.min.js" defer></script>

    <!-- Local Bootstrap JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>


    <style>
        .highlight {
            outline: 2px solid black !important;
            /* just a visible black outline */
            outline-offset: 2px;
            /* optional spacing */
        }
    </style>

</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
 <div x-data="{ is_admin: {{ 1 if is_admin else 0 }}, active: 'customers', loaded: { customers: false, events: false, calls: false } }"
  x-init="
    // Automatically load the customers content at startup
    $nextTick(() => {
      if (!loaded.customers && $refs.customerContent) {
        $refs.customerContent.click();
        loaded.customers = true;
      }
    })
  ">




<header class="bg-white shadow sticky top-0 z-10" x-data="{ open: false }">
  <div class="max-w-7xl mx-auto px-4 py-1 flex items-center justify-between">
    <!-- App name -->
    <div class="text-xl font-semibold">
      {{ "APPNAME" | t }}
    </div>

    <!-- Mobile menu toggle -->
    <button @click="open = !open" class="md:hidden p-2 rounded hover:bg-gray-100">
      <svg x-show="!open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <svg x-show="open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- NAVIGATION (Desktop) -->
    <nav class="hidden md:flex items-center space-x-4">
      <!-- User Info -->
      <div class="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded">
        <span>{{ user }} {{ caller }}</span>
        <form method="get" action="/logout" class="inline">
          <button type="submit" class="text-sm text-gray-600 hover:text-red-600">
            {{ "Logout" | t }}
          </button>
        </form>
      </div>

      <!-- Shared buttons template -->
      <template x-ref="navButtons">


        {%- set call = 1 -%}
        {%- set faktura = 0 -%}

        {%- if faktura -%}
        <button 
          @click="
            active = 'user';
            if(!loaded.user) {
              $refs.userContent.click();
              loaded.user = true;
            }
          "
          :class="{'bg-gray-200': active === 'user'}"
          class="px-3 py-2 rounded hover:bg-gray-200">
          {{ "User" | t }}
        </button>

        <button 
          @click="
            active = 'companies';
            if(!loaded.companies) {
              $refs.companiesContent.click();
              loaded.companies = true;
            }
          "
          :class="{'bg-gray-200': active === 'companies'}"
          class="px-3 py-2 rounded hover:bg-gray-200">
          {{ "Companies" | t }}
        </button>

        <button 
          @click="
            active = 'invoice';
            if(!loaded.invoice) {
              $refs.invoiceContent.click();
              loaded.invoice = true;
            }
          "
          :class="{'bg-gray-200': active === 'invoice'}"
          class="px-3 py-2 rounded hover:bg-gray-200">
          {{ "Invoices" | t }}
        </button>
        {%- endif -%}
        {%- if call -%}

                <button 
                    @click="
                        active = 'customers';
                        if(!loaded.customers) {
                            $refs.customerContent.click();
                            loaded.customers = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'customers'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    {{ "Customers" | t }}
                </button>

                <button 
                    @click="
                        active = 'events';
                        if(!loaded.events) {
                            $refs.eventContent.click();
                            loaded.events = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'events'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    {{ "Events" | t }}
                </button>

                <button 
                    @click="
                        active = 'calls';
                        if(!loaded.calls) {
                            $refs.callsContent.click();
                            loaded.calls = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'calls'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    {{ "Call Center" | t }}
                </button>

                <button 
                    @click="
                        active = 'alarms';
                        $refs.alarmsContent.click();
                    "
                    :class="{'bg-gray-200': active === 'alarms'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    {{ "Alarms" | t }}
                </button>
                <button 
                    x-show = is_admin
                    @click="
                        active = 'admin';
                        $refs.adminContent.click();
                    "
                    :class="{'bg-gray-200': active === 'alarms'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    {{ "Admin" | t }}
                </button>


            {%- endif -%}


      </template>

      <!-- Render them -->
      <div x-html="$refs.navButtons.innerHTML"></div>
    </nav>
  </div>

  <!-- NAVIGATION (Mobile dropdown) -->
  <div x-show="open" x-transition class="md:hidden border-t bg-white">
    <div class="px-4 py-3 space-y-3">
      <!-- User Info -->
      <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
        <span>{{ user }} {{ caller }}</span>
        <form method="get" action="/logout">
          <button type="submit" class="text-sm text-gray-600 hover:text-red-600">
            {{ "Logout" | t }}
          </button>
        </form>
      </div>

      <!-- Reuse same buttons -->
      <div x-html="$refs.navButtons.innerHTML" 
           @click="open = false" 
           class="flex flex-col gap-2"></div>
    </div>
  </div>
</header>


    <!-- Hidden HTMX triggers -->
    <div style="display:none">
        <button x-ref="userContent" hx-get="{{ url_for('user') }}" hx-target="#user_content" hx-push-url="false"></button>
        <button x-ref="customerContent" hx-get="{{ url_for('customers_list') }}" hx-target="#customer_content" hx-push-url="false"></button>
        <button x-ref="eventContent" hx-get="{{ url_for('events_list') }}" hx-target="#event_content" hx-push-url="false"></button>
        <button x-ref="callsContent" hx-get="{{ url_for('calls_dashboard') }}" hx-target="#calls_content" hx-push-url="false"></button>
        <button x-ref="invoiceContent" hx-get="{{ url_for('invoices_list') }}" hx-target="#invoice_content" hx-push-url="false"></button>
        <button x-ref="companiesContent" hx-get="{{ url_for('companies_list') }}" hx-target="#companies_content" hx-push-url="false"></button>
        <button x-ref="alarmsContent" hx-get="{{ url_for('alarms_list') }}" hx-target="#alarm_content" hx-push-url="false"></button>
        <button x-ref="adminContent" hx-get="{{ url_for('admin_dashboard') }}" hx-target="#admin_content" hx-push-url="false"></button>
    </div>
    <!-- Main content -->
    <main class="mx-auto p-1 w-full">
        <div id="user_content" x-show="active === 'user'" class="bg-white rounded shadow p-4">
        </div>
        <div id="customer_content" x-show="active === 'customers'" class="bg-white rounded shadow p-4">
        </div>
        <div id="companies_content" x-show="active === 'companies'" class="bg-white rounded shadow p-4">
        </div>
        <div id="event_content" x-show="active === 'events'" class="bg-white rounded shadow p-4">
        </div>
        <div id="calls_content" x-show="active === 'calls'" class="bg-white rounded shadow p-4">
        </div>
        <div id="alarm_content" x-show="active === 'alarms'" class="bg-white rounded shadow p-4">
        </div>
        <div id="invoice_content" x-show="active === 'invoice'" class="bg-white rounded shadow p-4">
        </div>
        <div id="admin_content" x-show="active === 'admin'" class="bg-white rounded shadow p-4">
        </div>

    </main>
</div>


<!-- Global Modal Container -->
<div 
    x-data="{ modalTitle: '' }"
    x-show="$store.modal.open" 
    x-transition.opacity 
    x-cloak
    :class="$store.modal.open ? 'modal fade show d-block' : 'modal fade'" 
    tabindex="-1" 
    role="dialog"
    @keydown.escape.window="$store.modal.open = false"
    style="background-color: rgba(0,0,0,0.5);"
>
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">


        <!-- Header -->
        <div class="modal-header">
      <h5 class="modal-title" x-text="$store.modal.title"></h5>
                <button type="button" class="btn-close" @click="$store.modal.open = false"></button>
        </div>

      <!-- HTMX swaps modal contents here -->
      <div class="modal-body" id="modal-container" style="max-height: 80vh; overflow-y: auto;">
        </div>

    </div>
  </div>
</div>

{%- if call -%}
<!-- Mobile View/Desktop -->
    <script>
        if (/Mobi|Android/i.test(navigator.userAgent)) {
                window.location.href = "/calls/number";
        }
    </script>
{%- endif -%}

<!-- Popup div -->
    <div id="popup" class="alert position-fixed top-0 start-50 translate-middle-x"
        style="display:none; padding:10px 20px; border-radius:5px; z-index:1000; transition: opacity 0.3s;">
    </div>

    <script>

function showPopup(evt) {
    console.log("popup")
    let xhr = evt.detail.xhr;
    let contentType = xhr.getResponseHeader('Content-Type') || '';
    let status = xhr.status;
    let messages = [];
    let isError = false;

    const popup = document.getElementById('popup');
    if (!popup) return;

    const hx_message = evt.detail.xhr.getResponseHeader("HX-Popup-Message");

    // First, check if popup has a data-detail attribute
    if (hx_message) {
        messages.push(hx_message);
    } 
    // Otherwise, handle JSON response
    else if (contentType.includes('application/json')) {
        try {
            let data = JSON.parse(xhr.responseText);

            if (status >= 400 && status < 600) isError = true;

            if (data.detail) {
                if (Array.isArray(data.detail) && data.detail.length > 0) {
                    data.detail.forEach(err => {
                        if (err.type === "missing") isError = true;
                        let field = err.loc && err.loc.length ? err.loc[0] : 'Field';
                        field = field.charAt(0).toUpperCase() + field.slice(1);
                        messages.push(`${field} is not correct`);
                    });
                } else if (!Array.isArray(data.detail)) {
                    messages.push(data.detail);
                    if (data.detail.type === "missing") isError = true;
                }
            }

            if (messages.length === 0 && !isError) messages.push("Done!");
        } catch (err) {
            console.error("Invalid JSON from server:", xhr.responseText);
            messages.push("Error parsing JSON response");
            isError = true;
        }
    } else {
        return; // unsupported content type
    }

    // Show popup
    if (messages.length > 0) {
        popup.innerText = messages.join('\n');
        popup.classList.remove('alert-success', 'alert-danger');
        popup.classList.add(isError ? 'alert-danger' : 'alert-success');
        popup.style.display = 'block';
        popup.style.opacity = '1';

        // Fade out
        setTimeout(() => {
            popup.style.opacity = '0';
            setTimeout(() => popup.style.display = 'none', 300);
        }, 2000);
    }
}

        // Attach to all HTMX requests globally
        document.body.addEventListener('htmx:afterSwap', showPopup);
    </script>

    <script src="/static/js/json-enc.js"></script>
    <script _src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>


    <!-- Global Alpine Confirm Dialog -->
    <div x-data="confirmDialog()" @confirm-dialog.window="open($event)">
        <template x-if="show">
            <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-80">
                    <h2 class="text-lg font-semibold">{{ "Confirm" | t }}</h2>
                    <p class="mt-2 text-sm text-gray-600" x-text="message"></p>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button @click="cancel()" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">
                            {{ "Cancel" | t }}
                        </button>
                        <button @click="proceed()" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">
                            {{ "Yes" | t }}
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        document.addEventListener("alpine:init", () => {
            // Register a directive like `x-confirm`
            console.log("init event listener");
            Alpine.directive("confirm", (el, { expression }) => {
                el.addEventListener("click", (e) => {
                    e.preventDefault(); // Stop immediate action
                    el.dispatchEvent(new CustomEvent("confirm-dialog", {
                        bubbles: true,
                        detail: { message: expression, target: el }
                    }));
                });
            });
        });

        function confirmDialog() {
            return {
                show: false,
                message: "",
                targetEl: null,
                open(e) {
                    this.targetEl = e.detail.target;
                    this.message = e.detail.message;
                    this.show = true;
                },
                cancel() {
                    this.show = false;
                    this.targetEl = null;
                },
                proceed() {
                    this.show = false;
                    if (this.targetEl) {
                        htmx.trigger(this.targetEl, "confirmed");
                    }
                }
            }
        }
    </script>
  


<script>
let ws;
let wsToken;
const nameEl = document.querySelector("#name");
const numberEl = document.querySelector("#number");
const callHref = document.querySelector("#call_href");

async function fetchToken() {
    const res = await fetch(`${location.protocol}//${location.host}/get-ws-token`, {
        credentials: "include"
    });
    const data = await res.json();
    wsToken = data.ws_token;
}

function createWebSocket(url) {
    return new Promise((resolve, reject) => {
        const socket = new WebSocket(url);

        socket.onopen = () => resolve(socket);
        socket.onerror = () => reject(new Error(`Cannot connect via ${url}`));
    });
}

async function connectWS() {
    await fetchToken();

    const protocols = ["wss", "ws"];
    let connected = false;

    for (let proto of protocols) {
        const url = `${proto}://${location.host}/calls/ws?token=${wsToken}`;
        try {
            ws = await createWebSocket(url);
            console.log(`WebSocket connected via ${proto}!`);
            connected = true;


            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Recieved", data)
                if (data.call) {
                    console.log("Call");
                    enableCallButtons();
                }
            };

            // Handle close
            ws.onclose = () => {
                console.log(`WebSocket (${proto}) closed. Reconnecting in 1s...`);
                setTimeout(connectWS, 1000);
            };

            // Ping
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }
            }, 10000);

            break; // exit loop once connected
        } catch (err) {
            console.warn(`${proto} connection failed, trying next...`);
        }
    }

    if (!connected) {
        console.error("Failed to connect via both WSS and WS. Retrying in 5s...");
        setTimeout(connectWS, 5000);
    }
}


// Start automatically
connectWS();
</script>
  

<script defer>

    document.addEventListener('alpine:init', () => {

    Alpine.store('eventFilters', {
        activism: true,
        lectures: true,
        parties: true,
        politics: true
    });

    Alpine.store('event', {
        id: "",
    });

    Alpine.store('customer', {
        comment: "",
        id: "",
    });

    Alpine.store('call', {
        comment: "",
        id: "",
    });

    Alpine.store('eventCustomer', {
        status: "",
    });

    Alpine.store('modal', {
        title: "",
        open: false
    });




});

</script>

<!-- empty title when modal.open is false-->
<div x-data x-effect="$store.modal.open || ($store.modal.title = '')"></div>

<meta name="htmx-history-cache-size" content="0">

<script>
function reloadDashboard() {
  htmx.ajax('GET', '/calls/dashboard', { target: '#calls_content' });
  console.log("dashboard reload");
}

function reloadAlarms() {
  htmx.ajax('GET', '/alarms/', { target: '#alarm_content' });
  console.log("alarms reload");
}

function reloadEvents() {
  htmx.ajax('GET', '/events/', { target: '#event_content' });
  console.log("events reload");
}

// Attach event listeners once, so custom events still work
document.body.addEventListener('dashboardReload', reloadDashboard);
document.body.addEventListener('alarmsReload', reloadAlarms);
</script>