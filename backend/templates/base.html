<!DOCTYPE html>
<html lang="en" x-data="{ modalOpen: false }" x-cloak>

<head>
    <meta charset="UTF-8">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/output.css">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <script src="/static/css/tailwind.css"></script>


    <!-- HTMX and Alpine.js from /static -->
    <script src="/static/htmx.min.js"></script>
    <script src="/static/alpine.min.js" defer></script>

    <!-- Local Bootstrap JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>

    <style>
        .highlight {
            outline: 2px solid black !important;
            /* just a visible black outline */
            outline-offset: 2px;
            /* optional spacing */
        }
    </style>

</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
 <div x-data="{ active: 'customers', loaded: { customers: false, events: false, calls: false } }">
    <header class="bg-white shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto p-3 w-full flex items-center justify-between">
            <div class="text-xl font-semibold">Call Center</div>
            <nav class="flex space-x-4">

<!-- User info + logout grouped, aligned left -->
<div class="card d-flex flex-row align-items-center p-2 mb-0" style="background-color: #f8f9fa; max-width: 250px;">
    <span>
        {{ user }} {{ caller }}
    </span>

<form method="get" action="/logout" class="mb-0 ms-2">
    <button type="submit" class="btn-light">
        Logout
    </button>
</form></div>


                <!-- Customers -->
                <button 
                    @click="
                        active = 'customers';
                        if(!loaded.customers) {
                            $refs.customerContent.click();
                            loaded.customers = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'customers'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    Customers
                </button>

                <!-- Events -->
                <button 
                    @click="
                        active = 'events';
                        if(!loaded.events) {
                            $refs.eventContent.click();
                            loaded.events = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'events'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    Events
                </button>

                <!-- Call Center -->
                <button 
                    @click="
                        active = 'calls';
                        if(!loaded.calls) {
                            $refs.callsContent.click();
                            loaded.calls = true;
                        }
                    "
                    :class="{'bg-gray-200': active === 'calls'}"
                    class="px-3 py-2 rounded hover:bg-gray-200">
                    Call Center
                </button>


            </nav>
        </div>
    </header>

    <!-- Hidden HTMX triggers -->
    <div style="display:none">
        <button x-ref="customerContent" hx-get="{{ url_for('customers_list') }}" hx-target="#customer_content" hx-push-url="false"></button>
        <button x-ref="eventContent" hx-get="{{ url_for('events_list') }}" hx-target="#event_content" hx-push-url="false"></button>
        <button x-ref="callsContent" hx-get="{{ url_for('calls_dashboard') }}" hx-target="#calls_content" hx-push-url="false"></button>
    </div>
    <!-- Main content -->
    <main class="max-w-7xl mx-auto p-4 w-full">
        <!-- Customers -->
        <div id="customer_content" x-show="active === 'customers'" class="bg-white rounded shadow p-4">
            {% block content %}{% endblock %}
        </div>

        <!-- Events -->
        <div id="event_content" x-show="active === 'events'" class="bg-white rounded shadow p-4">
            <!-- HTMX content can load here -->
        </div>

        <!-- Calls -->
        <div id="calls_content" x-show="active === 'calls'" class="bg-white rounded shadow p-4">
            <!-- Alpine store persists here -->
        </div>
    </main>
</div>


<!-- Global Modal Container -->
<div 
    x-data="{ modalTitle: '' }"
    x-show="modalOpen" 
    x-transition.opacity 
    x-cloak
    :class="modalOpen ? 'modal fade show d-block' : 'modal fade'" 
    tabindex="-1" 
    role="dialog"
    @keydown.escape.window="modalOpen = false"
    @click.self="modalOpen = false"
    style="background-color: rgba(0,0,0,0.5);"
>
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">


        <!-- Header -->
        <div class="modal-header">
      <h5 class="modal-title" x-text="$store.modal.title"></h5>
                <button type="button" class="btn-close" @click="modalOpen = false"></button>
        </div>

      <!-- HTMX swaps modal contents here -->
      <div class="modal-body" id="modal-container" style="max-height: 80vh; overflow-y: auto;">
        </div>

    </div>
  </div>
</div>

    <script>
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            window.location.href = "/calls/number";
        }

    </script>


    <!-- Popup div -->
    <div id="popup" class="alert position-fixed top-0 start-50 translate-middle-x"
        style="display:none; padding:10px 20px; border-radius:5px; z-index:1000; transition: opacity 0.3s;">
    </div>


    <script>

        function showPopup(evt) {
            let xhr = evt.detail.xhr;
            let contentType = xhr.getResponseHeader('Content-Type') || '';
            let status = xhr.status;

            if (!contentType.includes('application/json')) return;

            try {
                let data = JSON.parse(xhr.responseText);
                let messages = [];
                let isError = false;

                // Error if HTTP status is 4xx or 5xx
                if (status >= 400 && status < 600) {
                    isError = true;
                }

                // Check detail field for errors
                if (data.detail) {
                    if (Array.isArray(data.detail) && data.detail.length > 0) {
                        data.detail.forEach(err => {
                            if (err.type === "missing") {
                                isError = true;
                            }
                            let field = err.loc && err.loc.length ? err.loc[0] : 'Field';
                            field = field.charAt(0).toUpperCase() + field.slice(1);
                            messages.push(`${field} is not correct`);
                        });
                    } else if (!Array.isArray(data.detail)) {
                        messages.push(JSON.stringify(data.detail));
                        if (data.detail.type === "missing") {
                            isError = true;
                        }
                    }
                }

                if (messages.length === 0 && !isError) {
                    messages.push("All good!");
                }

                let popup = document.getElementById('popup');
                popup.innerText = messages.join('\n');

                // ✅ Remove previous Bootstrap alert classes
                popup.classList.remove('alert-success', 'alert-danger');

                // ✅ Add the correct Bootstrap class
                popup.classList.add(isError ? 'alert-danger' : 'alert-success');

                // Show popup
                popup.style.display = 'block';
                popup.style.opacity = '1';

                // Fade out
                setTimeout(() => {
                    popup.style.opacity = '0';
                    setTimeout(() => popup.style.display = 'none', 300);
                }, 2000);

            } catch (err) {
                console.error("Invalid JSON from server:", xhr.responseText);
            }
        }


        // Attach to all HTMX requests globally
        document.body.addEventListener('htmx:afterRequest', showPopup);
    </script>

    <script src="/static/js/json-enc.js"></script>
    <script _src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>


    <!-- Global Alpine Confirm Dialog -->
    <div x-data="confirmDialog()" @confirm-dialog.window="open($event)">
        <template x-if="show">
            <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-80">
                    <h2 class="text-lg font-semibold">Confirm</h2>
                    <p class="mt-2 text-sm text-gray-600" x-text="message"></p>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button @click="cancel()" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">
                            Cancel
                        </button>
                        <button @click="proceed()" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">
                            Yes
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        document.addEventListener("alpine:init", () => {
            // Register a directive like `x-confirm`
            console.log("init event listener");
            Alpine.directive("confirm", (el, { expression }) => {
                el.addEventListener("click", (e) => {
                    e.preventDefault(); // Stop immediate action
                    el.dispatchEvent(new CustomEvent("confirm-dialog", {
                        bubbles: true,
                        detail: { message: expression, target: el }
                    }));
                });
            });
        });

        function confirmDialog() {
            return {
                show: false,
                message: "",
                targetEl: null,
                open(e) {
                    this.targetEl = e.detail.target;
                    this.message = e.detail.message;
                    this.show = true;
                },
                cancel() {
                    this.show = false;
                    this.targetEl = null;
                },
                proceed() {
                    this.show = false;
                    if (this.targetEl) {
                        htmx.trigger(this.targetEl, "confirmed");
                    }
                }
            }
        }
    </script>
    <script>



        async function fetchToken() {
            const res = await fetch(`http://${location.host}/get-ws-token`, {
                credentials: "include"
            });
            const data = await res.json();
            wsToken = data.ws_token;
        }

        async function connectWS() {
            await fetchToken();

            ws = new WebSocket(`ws://${location.host}/calls/ws?token=${wsToken}`);

            ws.onopen = () => console.log("WebSocket connected!");
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
 //               console.log("Recieved", data)
                if (data.call) {
                    const fieldset = document.querySelector('#call-fields');
                    // Enable the fieldset itself
                    fieldset.disabled = false;
                }
            };

            ws.onclose = async () => {
                console.log("WebSocket closed. Reconnecting...");
                // Wait a second before reconnect
                setTimeout(connectWS, 1000);
            };

            // Send ping messages every x seconds
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }
            }, 10000);
        }



        // Start automatically
        connectWS();
    </script>


<script defer>

    document.addEventListener('alpine:init', () => {
    Alpine.store('eventFilters', {
        activism: true,
        lectures: true,
        parties: true,
        politics: true
    });

    Alpine.store('event', {
        id: "",
    });

    Alpine.store('customer', {
        comment: "",
        id: "",
    });

    Alpine.store('call', {
        comment: "",
        id: "",
    });

    Alpine.store('eventCustomer', {
        status: "",
    });

    Alpine.store('modal', {
        title: "",
        open: false
    });


});

</script>

<meta name="htmx-history-cache-size" content="0">