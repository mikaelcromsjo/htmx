<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}{{ "Dashboard" | t }}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/tailwind.css">

    <!-- HTMX and Alpine.js from /static -->
    <script src="/static/htmx.min.js"></script>
    <script src="/static/alpine.min.js" defer></script>

    <!-- Local Bootstrap JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>

    <style>
        .highlight {
            outline: 2px solid black !important;
            /* just a visible black outline */
            outline-offset: 2px;
            /* optional spacing */
        }
    </style>

</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
 <div>
    <header class="bg-white shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto p-3 w-full flex items-center justify-between">
            <div class="text-xl font-semibold">{{ "APPNAME" | t }}</div>
            <nav class="flex space-x-4">
            </nav>
        </div>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto p-4 w-full">
        <!-- Content -->
        <div id="content" x-show="active === 'customers'" class="bg-white rounded shadow p-4">
            {% block content %}{% endblock %}
        </div>

    </main>
</div>


<script>
let ws;
let wsToken;
const nameEl = document.querySelector("#name");
const numberEl = document.querySelector("#number");
const callHref = document.querySelector("#call_href");

async function fetchToken() {
    const res = await fetch(`${location.protocol}//${location.host}/get-ws-token`, {
        credentials: "include"
    });
    const data = await res.json();
    wsToken = data.ws_token;
}

function createWebSocket(url) {
    return new Promise((resolve, reject) => {
        const socket = new WebSocket(url);

        socket.onopen = () => resolve(socket);
        socket.onerror = () => reject(new Error(`Cannot connect via ${url}`));
    });
}

async function connectWS() {
    await fetchToken();

    const protocols = ["wss", "ws"];
    let connected = false;

    for (let proto of protocols) {
        const url = `${proto}://${location.host}/calls/ws?token=${wsToken}`;
        try {
            ws = await createWebSocket(url);
            console.log(`WebSocket connected via ${proto}!`);
            connected = true;

            // Set message handler
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("data",data);
                if (data.name) {
                    nameEl.textContent = data.name;
                    numberEl.textContent = data.number;
                    callHref.href = "tel:" + data.number;
                }
            };

            // Handle close
            ws.onclose = () => {
                console.log(`WebSocket (${proto}) closed. Reconnecting in 1s...`);
                setTimeout(connectWS, 1000);
            };

            // Ping
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }
            }, 10000);

            break; // exit loop once connected
        } catch (err) {
            console.warn(`${proto} connection failed, trying next...`);
        }
    }

    if (!connected) {
        console.error("Failed to connect via both WSS and WS. Retrying in 5s...");
        setTimeout(connectWS, 5000);
    }
}

function call() {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.log("WebSocket not connected yet");
        return;
    }
    ws.send(JSON.stringify({ call: true }));
}

// Start automatically
connectWS();
</script>

<meta name="htmx-history-cache-size" content="0">