<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}{{ "Dashboard" | t }}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/tailwind.css">


    <!-- HTMX and Alpine.js from /static -->
    <script src="/static/htmx.min.js"></script>
    <script src="/static/alpine.min.js" defer></script>


</head>

<body class="flex flex-col">
    <!-- Header -->
 <div>


    <!-- Main content -->
    <main class="max-w-7xl mx-auto p-4 w-full">
        <!-- Content -->
        <div id="content" x-show="active === 'customers'" class="p-4">
            {% block content %}{% endblock %}
        </div>

    </main>

      <div class="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded">
        <span>{{ caller }}</span>
        <form method="get" action="/logout" class="inline">
          <button type="submit" class="text-gray-600 hover:text-red-600">
            {{ "Logout" | t }}
          </button>
        </form>
      </div>


</div>



    <script src="/static/js/json-enc.js"></script>

<meta name="htmx-history-cache-size" content="0">

<script>
let ws;
let wsToken;
const nameEl = document.querySelector("#name");
const numberEl = document.querySelector("#number");
const callHref = document.querySelector("#call_href");

async function fetchToken() {
    const res = await fetch(`${location.protocol}//${location.host}/get-ws-token`, {
        credentials: "include"
    });
    const data = await res.json();
    wsToken = data.ws_token;
}

function createWebSocket(url) {
    return new Promise((resolve, reject) => {
        const socket = new WebSocket(url);

        socket.onopen = () => resolve(socket);
        socket.onerror = () => reject(new Error(`Cannot connect via ${url}`));
    });
}

async function connectWS() {
    await fetchToken();

    const protocols = ["wss", "ws"];
    let connected = false;

    for (let proto of protocols) {
        const url = `${proto}://${location.host}/calls/ws?token=${wsToken}`;
        try {
            ws = await createWebSocket(url);
            console.log(`WebSocket connected via ${proto}!`);
            connected = true;

            // Set message handler
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("data",data);
                if (data.name) {
                    nameEl.textContent = data.name;
                    numberEl.textContent = data.number;
                    callHref.href = "tel:" + data.number;
                }
            };

            // Handle close
            ws.onclose = () => {
                console.log(`WebSocket (${proto}) closed. Reconnecting in 1s...`);
                setTimeout(connectWS, 1000);
            };

            // Ping
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }
            }, 10000);

            break; // exit loop once connected
        } catch (err) {
            console.warn(`${proto} connection failed, trying next...`);
        }
    }

    if (!connected) {
        console.error("Failed to connect via both WSS and WS. Retrying in 5s...");
        setTimeout(connectWS, 5000);
    }
}

function call() {
    console.log("call clicked")
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.log("WebSocket not connected yet");
        return;
    }
    const number = document.querySelector("#number").textContent;
    console.log(number);
    ws.send(JSON.stringify({ call: true, number: number }));
}

// Start automatically
connectWS();
</script>

<meta name="htmx-history-cache-size" content="0">