 <div x-init="$store.modal.title = '{{ "Customer" | t }}: {{ customer.first_name }} {{ customer.last_name }}'"></div> 

<form
    hx-post="{{ url_for('upsert_customer') }}"
    hx-target="#customer-list"
    hx-validate="true"
    hx-on:submit="if (!this.reportValidity()) { event.preventDefault(); return false; }" 
    hx-swap="innerHTML"
    hx-ext="json-enc"
    hx-headers='{"Content-Type": "application/json"}'
    hx-on:htmx:configRequest="(evt) => {
        const data = evt.detail.parameters;
        for (const key in data) {
            if (data[key] === '') data[key] = null;
        }
    }"
    hx-on:htmx:afterRequest="
    console.log('after');
        if(event.detail.xhr.status === 200){
            $store.modal.open = false; // close modal manually
        } else if(event.detail.xhr.status >= 400){
            showPopup(event); // show backend validation errors
        }
    "
    
>

    {% if customer.id %}
    <!-- ID -->
    <div class="mb-2 hidden">
        <label class="block font-semibold">{{ "ID" | t }}</label>
        <input type="text" name="id" value="{{ customer.id }}" class="border p-1 w-full"/>
    </div>
    {% endif %}

    <!-- First Name -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "First Name" | t }}</label>
        <input type="text" name="first_name" value="{{ customer.first_name or '' }}" class="border p-1 w-full"/>
    </div>

    <!-- Last Name -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Last Name" | t }}</label>
        <input type="text" name="last_name" value="{{ customer.last_name or '' }}" class="border p-1 w-full"/>
    </div>


    <!-- Code Name -->
    <div class="mb-2">
        <label class="inline-flex items-center">
            <input type="hidden" name="code_name" value="false">
            <input type="checkbox" name="code_name" value="1" {% if customer.code_name %}checked{% endif %} class="mr-2"/>
            {{ "Code Name" | t }}
        </label>
    </div>

    <!-- Email -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Email" | t }}</label>
        <input type="email" name="email" value="{{ customer.email or '' }}" class="border p-1 w-full"/>
    </div>

    <!-- Phone -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Phone" | t }}</label>
        <input type="text" name="phone" value="{{ customer.phone or '' }}" class="border p-1 w-full"/>
    </div>

<div class="mb-2 tagify-wrapper"
     x-data
     data-object-type="location">
    <label class="block font-semibold">{{ "Location" | t }}</label>
    <input id="no-tag-input" name="location" value="{{ customer.location or ' ' }}" class="border p-1 w-full"/>
</div>


    <!-- Contributes -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Contributes" | t }}</label>
        <select name="contributes" class="border p-1 w-full">
            <option value="" {% if customer.contributes is none %}selected{% endif %}>{{ "Select..." | t }}</option>
            <option value="1" {% if customer.contributes == 1 %}selected{% endif %}>{{ "No contributions" | t }}</option>
            <option value="2" {% if customer.contributes == 2 %}selected{% endif %}>{{ "Gives Donation" | t }}</option>
            <option value="6" {% if customer.contributes == 6 %}selected{% endif %}>{{ "Subscriber" | t }}</option>
            <option value="3" {% if customer.contributes == 3 %}selected{% endif %}>{{ "Silver" | t }}</option>
            <option value="4" {% if customer.contributes == 4 %}selected{% endif %}>{{ "Gold" | t }}</option>
            <option value="5" {% if customer.contributes == 5 %}selected{% endif %}>{{ "Platinum" | t }}</option>
        </select>
    </div>

    <!-- Caller -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Caller" | t }}</label>
        <select name="caller_id" class="border p-1 w-full">
            <option value="" {% if customer.caller is none %}selected{% endif %}>{{ "Select..." | t }}</option>
            {% for caller in callers %}
              <option value="{{ caller.id }}" {% if customer.caller_id == caller.id %}selected{% endif %}>{{ caller.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Comment -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Comment" | t }}</label>
        <textarea name="comment" class="border p-1 w-full">{{ customer.comment or '' }}</textarea>
    </div>

    <!-- Sub Caller -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Sub Caller" | t }}</label>
        <input type="text" name="sub_caller" value="{{ customer.sub_caller or '' }}" class="border p-1 w-full"/>
    </div>

    <!-- Organisations -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Organisations" | t }}</label>
        <select name="organisations" multiple class="border p-1 w-full">
            {% for org in organisations %}
                <option value="{{ org.id }}"
                    {% if org.id|string in customer.organisations %}selected{% endif %}>
                    {{ org.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Categories -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Categories" | t }}</label>
        <select name="categories" multiple class="border p-1 w-full" style="height:300px">
          {% for cid, cat in categories.items() %}
            <optgroup label="{{ cat.name }}">
              {% for iid, item in cat.get('items', {}).items() %}
                <option value="{{ iid }}" {% if iid in customer.categories %}selected{% endif %}>
                  {{ item }}
                </option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
    </div>

<!-- Personality Type -->
<div class="mb-2">
    <label class="block font-semibold">{{ "Personality Type" | t }}</label>
    <select name="personality_type" class="border p-1 w-full">
        <option value="" {% if customer.personality_type is none %}selected{% endif %}>{{ "Select..." | t }}</option>
        {% for p in personalities %}
            <option value="{{ p.id }}" {% if customer.personality_type == p.id %}selected{% endif %}>
                {{ p.name }}
            </option>
        {% endfor %}
    </select>
</div>

 <!-- Boolean Preferences -->
<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="controlled" value="false">
        <input type="checkbox" name="controlled" value="true" {% if customer.controlled %}checked{% endif %} class="mr-2"/>
        {{ "Controlled" | t }}
    </label>
</div>

<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="filter_a" value="false">
        <input type="checkbox" name="filter_a" value="true" {% if customer.filter_a %}checked{% endif %} class="mr-2"/>
        {{ "Likes Parties" | t }}
    </label>
</div>

<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="filter_b" value="false">
        <input type="checkbox" name="filter_b" value="true" {% if customer.filter_b %}checked{% endif %} class="mr-2"/>
        {{ "Likes AW" | t }}
    </label>
</div>

<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="filter_c" value="false">
        <input type="checkbox" name="filter_c" value="true" {% if customer.filter_c %}checked{% endif %} class="mr-2"/>
        {{ "Likes Lectures" | t }}
    </label>
</div>

<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="filter_d" value="false">
        <input type="checkbox" name="filter_d" value="true" {% if customer.filter_d %}checked{% endif %} class="mr-2"/>
        {{ "Likes Activism" | t }}
    </label>
</div>

<div class="mb-2">
    <label class="inline-flex items-center">
        <input type="hidden" name="filter_e" value="false">
        <input type="checkbox" name="filter_e" value="true" {% if customer.filter_e %}checked{% endif %} class="mr-2"/>
        {{ "Likes Conferences" | t }}
    </label>
</div>

<div class="mb-2 tagify-wrapper"
     x-data
     x-init="initTagify($el)"
     data-object-type="tags">
    <label class="block font-semibold">{{ "Tags (comma separated)" | t }}</label>
    <input type="text" name="tags" value="{{ customer.tags | default('') }}" class="border p-1 w-full"/>
</div>

    <!-- User ID -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "User ID" | t }}</label>
        <input type="text" name="user_id" value="{{ customer.user_id or '' }}" class="border p-1 w-full"/>
    </div>


<!-- Extra 
<div class="mb-2">
    <label class="block font-semibold">{{ 'Customer Name' | t }}</label>
    <input type="text" name="extra.customer_name" value="{{ customer.extra.customer_name or '' }}" class="border p-1 w-full"/>
</div>
-->


    <div class="flex justify-end mt-4">
        <button @click="$store.modal.open = false" type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">{{ "Save" | t }}</button>
    </div>

</form>

<script>

    var input = document.querySelector('#no-tag-input'),
    tagify = new Tagify(input, {

whitelist: [
  "Stockholm",
  "Stockholm - Akalla",
  "Stockholm - Bromma",
  "Stockholm - Solna",
  "Stockholm - Södertälje",
  "Stockholm - Nacka",
  "Stockholm - Täby",
  "Stockholm - Haninge",
  "Stockholm - Huddinge",
  "Stockholm - Upplands Väsby",
  "Stockholm - Sundbyberg",

  "Uppsala",
  "Uppsala - Enköping",
  "Uppsala - Knivsta",
  "Uppsala - Tierp",
  "Uppsala - Östhammar",

  "Södermanland",
  "Södermanland - Nyköping",
  "Södermanland - Eskilstuna",
  "Södermanland - Katrineholm",
  "Södermanland - Strängnäs",
  "Södermanland - Trosa",

  "Östergötland",
  "Östergötland - Linköping",
  "Östergötland - Norrköping",
  "Östergötland - Motala",
  "Östergötland - Mjölby",
  "Östergötland - Finspång",

  "Jönköping",
  "Jönköping - Nässjö",
  "Jönköping - Värnamo",
  "Jönköping - Vetlanda",
  "Jönköping - Huskvarna",

  "Kronoberg",
  "Kronoberg - Växjö",
  "Kronoberg - Ljungby",
  "Kronoberg - Alvesta",
  "Kronoberg - Älmhult",
  "Kronoberg - Lessebo",

  "Kalmar",
  "Kalmar - Kalmar",
  "Kalmar - Västervik",
  "Kalmar - Oskarshamn",
  "Kalmar - Mönsterås",
  "Kalmar - Hultsfred",

  "Skåne",
  "Skåne - Malmö",
  "Skåne - Helsingborg",
  "Skåne - Lund",
  "Skåne - Kristianstad",
  "Skåne - Landskrona",
  "Skåne - Trelleborg",
  "Skåne - Ystad",
  "Skåne - Hässleholm",
  "Skåne - Eslöv",
  "Skåne - Ängelholm",

  "Halland",
  "Halland - Halmstad",
  "Halland - Kungsbacka",
  "Halland - Varberg",
  "Halland - Falkenberg",
  "Halland - Laholm",

  "Västra Götaland",
  "Västra Götaland - Göteborg",
  "Västra Götaland - Borås",
  "Västra Götaland - Trollhättan",
  "Västra Götaland - Skövde",
  "Västra Götaland - Uddevalla",
  "Västra Götaland - Vänersborg",
  "Västra Götaland - Lidköping",
  "Västra Götaland - Mölndal",
  "Västra Götaland - Partille",
  "Västra Götaland - Alingsås",

  "Värmland",
  "Värmland - Karlstad",
  "Värmland - Kristinehamn",
  "Värmland - Arvika",
  "Värmland - Säffle",
  "Värmland - Torsby",

  "Örebro",
  "Örebro - Örebro",
  "Örebro - Kumla",
  "Örebro - Karlskoga",
  "Örebro - Lindesberg",
  "Örebro - Hallsberg",

  "Västmanland",
  "Västmanland - Västerås",
  "Västmanland - Köping",
  "Västmanland - Fagersta",
  "Västmanland - Hallstahammar",
  "Västmanland - Surahammar",

  "Dalarna",
  "Dalarna - Falun",
  "Dalarna - Borlänge",
  "Dalarna - Mora",
  "Dalarna - Avesta",
  "Dalarna - Ludvika",

  "Gävleborg",
  "Gävleborg - Gävle",
  "Gävleborg - Sandviken",
  "Gävleborg - Bollnäs",
  "Gävleborg - Hudiksvall",
  "Gävleborg - Söderhamn",

  "Västernorrland",
  "Västernorrland - Härnösand",
  "Västernorrland - Sundsvall",
  "Västernorrland - Örnsköldsvik",
  "Västernorrland - Kramfors",
  "Västernorrland - Sollefteå",

  "Jämtland",
  "Jämtland - Östersund",
  "Jämtland - Åre",
  "Jämtland - Bräcke",
  "Jämtland - Krokom",
  "Jämtland - Strömsund",

  "Västerbotten",
  "Västerbotten - Umeå",
  "Västerbotten - Skellefteå",
  "Västerbotten - Lycksele",
  "Västerbotten - Vindeln",
  "Västerbotten - Robertsfors",

  "Norrbotten",
  "Norrbotten - Luleå",
  "Norrbotten - Boden",
  "Norrbotten - Piteå",
  "Norrbotten - Kiruna",
  "Norrbotten - Gällivare",

  "Gotland",
  "Gotland - Visby",
  "Gotland - Hemse",
  "Gotland - Slite",
  "Gotland - Klintehamn",
  "Gotland - Fårösund",

  "Blekinge",
  "Blekinge - Karlskrona",
  "Blekinge - Karlshamn",
  "Blekinge - Ronneby",
  "Blekinge - Sölvesborg",
  "Blekinge - Olofström"
],


        enforceWhitelist: true,
        mode : "select",
            })
</script>