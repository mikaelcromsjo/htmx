

<div id="customer-container">
    <div id="customer-list"
        x-data="{
            selected: JSON.parse(localStorage.getItem('selectedCustomers') || '{}'),
            showSelect: JSON.parse(localStorage.getItem('showSelect') || 'true'),
            toggle(id) {
                this.selected[id] = !this.selected[id];
                localStorage.setItem('selectedCustomers', JSON.stringify(this.selected));
            },
            toggleSelect() {
                this.showSelect = !this.showSelect;
                localStorage.setItem('showSelect', JSON.stringify(this.showSelect));
            },
clearSelectedIds() {
    // Loop through keys and set each to false
    for (const id in this.selected) {
        if (this.selected.hasOwnProperty(id)) {
            this.selected[id] = false;
        }
    }
    // Clear localStorage
    localStorage.removeItem('selectedCustomers');
    document.querySelectorAll('.customer-checkbox').forEach(cb => {
        if (cb.checked) {
            cb.checked = false;
//            cb.dispatchEvent(new Event('change')); // triggers Alpine toggle if needed
        }
    });
},
            getSelectedIds() {
                return Object.keys(this.selected)
                            .filter(id => this.selected[id])
                            .map(id => parseInt(id));
            }
        }"
    >

        <div class="full-table" x-data="searchTable()">
<div class="relative w-full max-w-sm my-2">
ðŸ”Žï¸Ž
    <!-- Input -->
    <input
        type="text"
        placeholder="SÃ¶k namn, e-post eller telefon..."
        class="border border-gray-300 rounded pl-14 pr-3 py-2 p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        x-model="query"
        @input.debounce.300ms="filterRows()"
    >


</div>
        <table class="table-auto w-full border overflow-x-auto">
            <thead>
                <tr>
                    <th class="px-2 py-1 border">{{ "Nr" | t }}</th>
                    <th class="px-2 py-1 border">{{ "Name" | t }}</th>
                    <th class="px-2 py-1 border">{{ "Email" | t }}</th>
                    <th class="px-2 py-1 border">{{ "Phone" | t }}</th>
                    <th class="px-2 py-1 border">{{ "Location" | t }}</th>
                    <th x-show="is_admin" class="px-2 py-1 border">{{ "Caller" | t }}</th>
                    <th class="px-2 py-1 border">{{ "Command" | t }}</th>
                    <th class="px-2 py-1 border text-center" 
                        @click.stop>
                        <input type="checkbox" @change="const checkAll = $event.target.checked;
                            document.querySelectorAll('.customer-checkbox').forEach(cb => {
                                if (cb.checked !== checkAll) {        // only toggle boxes that differ
                                    cb.checked = checkAll;
                                    cb.dispatchEvent(new Event('change')); // triggers Alpine toggle
                                }
                            })
                        ">
                        </th>

                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}?list=short"
                    hx-target="#customer-info"
                    hx-trigger="click"
                    class="cursor-pointer hover:bg-gray-100">

                    <td class="px-2 py-1 border">{{ loop.index  }}</td>
                    <td class="px-2 py-1 border">{{ customer.first_name }} {{ customer.last_name }}</td>
                    <td class="px-2 py-1 border">{{ customer.email or ''}}</td>
                    <td class="px-2 py-1 border">{{ customer.phone or ''}}</td>
                    <td class="px-2 py-1 border">{{ customer.location or '' }}</td>
                    <td x-show="is_admin" class="px-2 py-1 border">{{ customer.caller.name }}</td>

                    <td class="px-2 py-1 border text-center" 
                        @click.stop
                        >

                        <button 
                            hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
                            hx-target="#modal-container"
                            hx-swap="innerHTML"
                            @click="$store.modal.open = true"
                        >
                            {{ "Edit" | t }}
                        </button>                
                        <button 
                            x-show="is_admin"
                            hx-post="{{ url_for('delete_customer', customer_id=customer.id) }}"
                            hx-on="htmx:afterRequest: 
                                showPopup(event);
                                htmx.ajax('GET', '{{ url_for('customers_list') }}', {target:'#customer-container'}); "
                            hx-trigger="confirmed"
                            x-confirm="{{'Are you sure you want to delete this record?' | t }}"
                        >
                                                    {{ "Delete" | t }}
                        </button>   
                    </td>

                    <td class="px-2 py-1 border text-center" 
                        @click.stop>
                        <input type="checkbox" class="customer-checkbox"
                            :checked="selected[{{ customer.id }}] || false"
                            @change="toggle({{ customer.id }})">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
        <div class="mt-2 flex gap-2">
            <button hx-get="{{ url_for('customer_detail', customer_id=0) }}"
                    hx-target="#modal-container"
                    @click="$store.modal.open = true"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "New Customer" | t }}
            </button>

            <button hx-get="{{ url_for('customer_filter') }}"
                    hx-target="#modal-container"
                    @click="$store.modal.open = true"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Filter" | t }}
            </button>

<button 
    hx-post="{{ url_for('set_filter') }}"
    hx-target="#customer-list"
    hx-swap="innerHTML"
    hx-ext="json-enc"
    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">

                {{ "Clear Filter" | t }}
            </button>



<!--
            <button @click="toggleSelect()"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                    
                {{ "Toggle Select Column" | t }}
            </button>
-->

        </div>

        <div class="mt-2 flex gap-2">

        <button x-on:click="clearSelectedIds()"
                class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Clear Customers" | t }}
        </button>


        <button
                :hx-vals="JSON.stringify({ selected_ids: getSelectedIds() })"
                hx-post="/calls/dashboard"
                hx-ext="json-enc"
                hx-target="#calls_content"
                class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Load Selected Customers" | t }}
            </button>

<div x-data="{ caller_id: '', getSelectedIds }">

  <!-- Assign button -->
  <button
    :hx-vals="JSON.stringify({ caller_id: caller_id, selected_ids: { selected_ids: getSelectedIds() } })"
    hx-post="/customers/assign"
    hx-ext="json-enc"
    hx-swap="none"
    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200"
  >
    {{ 'Assign' | t }}
  </button>

  <!-- Caller selection -->
  <select
    id="caller-select"
    name="caller_id"
    x-model="caller_id"
    class="border"
  >
    <option value="">{{ 'Select...' | t }}</option>
    {% for caller in callers %}
      <option value="{{ caller.id }}">{{ caller.name }}</option>
    {% endfor %}
  </select>

</div>

</div> 

        
    <div class="mt-4" id="customer-info"></div>
        
    </div>

</div>

