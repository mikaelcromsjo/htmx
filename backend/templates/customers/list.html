<div id="customer-container">
    <div id="customer-list" x-data="{
            selectedRow: 0
        }">

        <div x-data="searchTable()">
            <div class="relative my-2">ðŸ”Žï¸Ž
                <!-- Input -->
                <input type="text" placeholder="{{ "Search name, number or phone." | t }}"
                    class="w-[400px] border border-gray-300 rounded pl-4 pr-3 py-2 p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    x-model="query" @input.debounce.300ms="filterRows()">
            </div>
            <div class="full-table">
                <table class="table-fixed w-full border overflow-x-auto">
                    <thead>
                        <tr>
                            <th class="w-[5%] px-2 py-1 border">{{ "Nr" | t }}</th>
                            <th class="w-[30%] px-2 py-1 border">{{ "Name" | t }}</th>
                            <th class="w-[20%] px-2 py-1 border">{{ "Email" | t }}</th>
                            <th class="w-[20%] px-2 py-1 border">{{ "Phone" | t }}</th>
                            <th class="w-[20%] px-2 py-1 border">{{ "Location" | t }}</th>
                            <th x-show="is_admin" class="w-[20%] px-2 py-1 border">{{ "Caller" | t }}</th>
                            <th class="w-[20%] px-2 py-1 border">{{ "Command" | t }}</th>
                            <th class="w-[5%] px-2 py-1 border text-center" @click.stop>
                                <input type="checkbox" @change="
                                    if ($event.target.checked) {
                                        $store.customers.selectVisible();
                                    } else {
                                        $store.customers.clearVisible();
                                    }
                                ">
                                
                            </th>

                        </tr>
                    </thead>
                    <tbody x-init="$store.customers.initInTable()">
                            {% for customer in customers %}
                        <tr                                      data-id="{{ customer.id }}"

                            x-show="$store.customers.isRowVisible({{customer.id}})"
                            hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}?list=short"
                            hx-target="#modal-container" 
                            hx-trigger="click" class="cursor-pointer" :class="{
                            'bg-green-100 font-bold text-green-600': selectedRow === {{ loop.index }},
                            'bg-white hover:bg-gray-100 text-gray-900': selectedRow != {{ loop.index }}
                        }" class="cursor-pointer" 
                        @click="selectedRow = {{ loop.index  }}; $store.modal.open = true">

{% set number = 0 %}  {# Default fallback value #}

{% if customer.last_call_date is not none %}
    {# Convert to date safely #}
    {% set last_call = customer.last_call_date %}
    {% set last_call_date = last_call.date() if last_call.__class__.__name__ == 'datetime' else None %}

    {% if last_call_date is not none %}
        {% set delta_days = (now().date() - last_call_date).days %}

        {% if delta_days == 0 %}
            {% set number = 600 %}
        {% elif delta_days == 1 %}
            {% set number = 500 %}
        {% elif delta_days == 2 %}
            {% set number = 400 %}
        {% elif delta_days <= -1 %}
            {% set number = 0 %}
        {% elif delta_days <= 7 %}
            {% set number = 300 %}
        {% elif delta_days <= 14 %}
            {% set number = 200 %}
        {% elif delta_days <= 21 %}
            {% set number = 100 %}
        {% elif delta_days <= 28 %}
            {% set number = 50 %}
        {% else %}
            {% set number = 0 %}
        {% endif %}
    {% endif %}
{% endif %}
                                
                                <td class="px-2 py-1 border bg-green-{{number}} ">{{
                                loop.index }}</td>
                                <td class="px-2 py-1 border">{{ customer.first_name }} {{ customer.last_name }}</td>
                                <td class="px-2 py-1 border">{{ customer.email or ''}}</td>
                                <td class="px-2 py-1 border">{{ customer.phone or ''}}</td>
                                <td class="px-2 py-1 border">{{ customer.location or '' }}</td>
                                <td x-show="is_admin" class="px-2 py-1 border">{{ customer.caller.name }}</td>

                                <td class="px-2 py-1 border text-center" @click.stop>

                                    <button hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
                                        hx-target="#modal-container" hx-swap="innerHTML"
                                        @click="$store.modal.open = true;">
                                        {{ "Edit" | t }}
                                    </button>
                                    <button x-show="is_admin"
                                        hx-post="{{ url_for('delete_customer', customer_id=customer.id) }}" hx-on="htmx:afterRequest: 
                                showPopup(event);
                                htmx.ajax('GET', '{{ url_for('customers_list') }}', {target:'#customer-container'}); "
                                        hx-trigger="confirmed"
                                        x-confirm="{{'Are you sure you want to delete this record?' | t }}">
                                        {{ "Delete" | t }}
                                    </button>
                                </td>

                                <td                                      
                                    class="px-2 py-1 border text-center" @click.stop>
                                    <input data-id="{{ customer.id }}" type="checkbox" class="customer-checkbox"
                            x-model="$store.customers.selected[{{ customer.id }}]">
                                </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-2 flex gap-2">
            <button hx-get="{{ url_for('customer_detail', customer_id=0) }}" hx-target="#modal-container"
                @click="$store.modal.open = true" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "New Customer" | t }}
            </button>

            <button hx-get="{{ url_for('customer_filter') }}" hx-target="#modal-container"
                @click="$store.modal.open = true" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Filter" | t }}
            </button>

            <button hx-post="{{ url_for('set_filter') }}" hx-target="#customer-list" hx-swap="innerHTML"
                hx-ext="json-enc" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">

                {{ "Clear Filter" | t }}
            </button>



            <!--
            <button @click="$store.customers.toggleSelect()"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                    
                {{ "Toggle Select Column" | t }}
            </button>
-->

        </div>

        <div class="mt-2 flex gap-2">

    <span
        class="inline-flex items-center justify-center rounded border rounded bg-gray-100 px-2 py-0.5"
        x-text="'{{ "Selected" | t }} ' + $store.customers.getSelectedIds().length"
    ></span>
            
            <button x-on:click="$store.customers.clearSelectedIds()" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Clear Customers" | t }}
            </button>


            <button id="reload-customers-btn" :hx-vals="JSON.stringify({ selected_ids: $store.customers.getSelectedIds() })" hx-post="/calls/customers"
                hx-ext="json-enc" hx-target="#calls-customer-list"
                class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                {{ "Load Selected Customers" | t }}
            </button>

                <!-- SMS -->

        <button id="mass-sms-btn"
            class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200"
            hx-post="/customers/data"
            hx-ext="json-enc"
            :hx-vals="JSON.stringify({
                selected_ids: $store.customers.getSelectedIds()
            })"
            hx-swap="none"
            hx-on="htmx:afterRequest: 
                console.log('test', event.detail.xhr.responseText);
                Alpine.store('customers')
                    .setSelectedCustomerData(JSON.parse(event.detail.xhr.responseText));
                showSmsModal(multiple=true);
            ">
                {{ "SMS" | t }}
            </button>


            <div x-data="{ caller_id: ''}">

                <!-- Assign button -->
                <button
                    :hx-vals="JSON.stringify({ caller_id: caller_id, selected_ids: { selected_ids: $store.customers.getSelectedIds() } })"
                    hx-post="/customers/assign" hx-ext="json-enc" hx-swap="none"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                    {{ 'Assign' | t }}
                </button>

                <!-- Caller selection -->
                <select id="caller-select" name="caller_id" x-model="caller_id" class="border p-1">

                    <option value="">{{ 'Select Caller...' | t }}</option>
                    {% for caller in callers %}
                    <option value="{{ caller.id }}">{{ caller.name }}</option>
                    {% endfor %}
                </select>

            </div>

        </div>
    </div>