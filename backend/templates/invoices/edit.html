 <div x-init="$store.modal.title = 'Invoice: {{ invoice.name }}'"></div> 
 <div x-init="$store.modal.submit = '{{ "Save" | t }}'"></div> 

<form 
    hx-post="{{ url_for('upsert_invoice') }}"
    hx-target="#invoice-container" 
    hx-ext="json-enc"
    hx-swap="innerHTML"
    x-init="
        $el.addEventListener('htmx:afterRequest', (event) => {
            if (event.detail.xhr.status === 200) {
                $store.modal.open = false;
            } else if (event.detail.xhr.status >= 400) {
                showPopup(event);
            }
        })
    "
    >

    {% if invoice.id %}
    <!-- ID -->
    <div class="mb-2">
        <label class="block font-semibold">{{ "Invoice ID" | t }}</label>
        {{ invoice.id }}
        <input hidden type="text" name="id" value="{{ invoice.id }}" class="border p-1 w-full"/>
    </div>
    {% endif %}


    <div class="mb-2">
        <label class="block font-semibold">{{ "Invoice Number" | t }}</label>
        {{ invoice.extra.number if invoice.extra else '' }}
    </div>

    {% if is_admin %}
    <div class="mb-2">
        <label class="block font-semibold">{{ "Status" | t }}</label>

<select name="extra.status" class="border p-1 mb-2">
    {% if invoice.extra.status|int == 1 %}
    <option value="1" {% if invoice.extra.status == "1" %}selected{% endif %}>Processing</option>
    {% endif %}

    {% if invoice.extra.status|int < 3 %}
        <option value="2" {% if invoice.extra.status == "2" %}selected{% endif %}>Ok</option>
    {% endif %}

    <option value="3" {% if invoice.extra.status == "3" %}selected{% endif %}>Canceled</option>
</select>

    </div>

    
    {% endif %}
    {% if not invoice.extra.status and not is_admin %}
        <input hidden type="text" name="extra.status" value="1" class="border p-1 w-full"/>
    {% endif %}


    <div class="mb-2">
        <label class="block font-semibold">{{ "Company" | t }}</label>
        <select name="company_id" class="border p-1 w-full">
            <option value="" {% if invoice.company is none %}selected{% endif %}>{{ "Select..." | t }}</option>
            {% for company in companies %}
              <option value="{{ company.id }}" {% if invoice.company_id == company.id %}selected{% endif %}>{{ company.extra.company_name }}</option>
            {% endfor %}
        </select>
    </div>


<div class="mb-2">
    <label class="block">{{ "Date" | t }}</label>
<input type="datetime-local" name="date" value="{{ invoice.date or '' }}"/>
</div>

<div class="mb-2">
    <label class="block">FÃ¶rfallodatum</label>

<input type="date"
       name="extra.due_date"
       value="{{ invoice.extra.get('due_date') or '' }}"/>
</div>

<div class="mb-2">
    <label class="block font-semibold">{{ 'VAT (%)' | t }}</label>
    <input type="number" step="1" id="vat" name="extra.vat" value="{{ invoice.extra.vat or '25' }}" class="border p-1 w-full"/>
</div>

<div class="mb-2">
    <label class="block font-semibold">{{ 'Note' | t }}</label>
    <input type="text" name="extra.note" value="{{ invoice.extra.note or '' }}" class="border p-1 w-full"/>
</div>

<!-- Add currency selector if you need it -->
<select id="currency" name="extra.currency" class="border p-1 mb-2">
    <option value="SEK" {% if invoice.extra.currency == "SEK" %} selected {% endif %} >SEK</option>
    <option value="EUR" {% if invoice.extra.currency == "EUR" %} selected {% endif %} >EUR</option>
</select>

<div>
<table id="invoiceTable" class="w-full min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
        <th scope="col" class="px-3 py-1">
            {{ "Description" | t }}
        </th>
        <th scope="col" class="px-3 py-1">
            {{ "Price" | t }}
        </th>
        <th scope="col" class="px-3 py-1">
            {{ "Qty" | t }}
        </th>
        <th scope="col" class="px-3 py-1">
            {{ "Total" | t }}
        </th>
        </tr>
    </thead>
    <tbody id="invoiceBody">
        {# --- Load existing rows from Jinja context --- #}
        {% set rows = invoice.extra.row if invoice.extra and invoice.extra.row else {} %}
        {% for key, row in rows.items() %}
        <tr class="">
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="text" name="extra.row.{{ key }}.description" value="{{ row.description }}" placeholder="{{ "Description" | t }}"></td>
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="number" name="extra.row.{{ key }}.price" value="{{ row.price }}" step="0.01" min="0"></td>
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="number" name="extra.row.{{ key }}.qty" value="{{ row.qty }}" step="1" min="0"></td>
            <td class="line-total">0.00</td>
        </tr>
        {% endfor %}
        {# --- If no rows, create one default row --- #}
        {% if not rows %}
        <tr>
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="text" name="extra.row.1.description" placeholder="{{ "Description" | t }}"></td>
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="number" name="extra.row.1.price" value="0" step="0.01" min="0"></td>
            <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="number" name="extra.row.1.qty" value="1" step="1" min="0"></td>
            <td class="line-total">0.00</td>
        </tr>
        {% endif %}
        </tbody>
        <tfoot>
        <tr>
            <td colspan="3" style="text-align:right;">{{ "Subtotal" | t }}:</td>
            <td id="subtotal">0.00</td>
        </tr>
        <tr>
            <td colspan="3" style="text-align:right;">{{ "VAT" | t }}:</td>
            <td id="vat_amount">0.00</td>
        </tr>
       <tr>
            <td colspan="3" style="text-align:right;">{{ "Total" | t }}:</td>
            <td id="total">0.00</td>
        </tr>
        </tfoot>
    </table>
</div>
<button id="addRow" type="button">{{ "Add Row" | t }}</button>
    <!-- Submit -->
    <div class="flex justify-end mt-4">
        <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">{{ "Save" | t }}</button>
    </div>
</form>

<script>
(() => {
  let rowCount = document.querySelectorAll('#invoiceBody tr').length || 1;

  function updateTotals() {
    const rows = document.querySelectorAll("#invoiceBody tr");
    let subtotal = 0;

    const currencyEl = document.querySelector('#currency');
    const currency = currencyEl ? currencyEl.value : "";

    rows.forEach((row) => {
      const price = parseFloat(row.querySelector(`[name$=".price"]`).value) || 0;
      const qty   = parseFloat(row.querySelector(`[name$=".qty"]`).value) || 0;

      const lineTotal = price * qty;

      row.querySelector(".line-total").textContent = lineTotal.toFixed(2) + " " + currency;

      subtotal += lineTotal;
    });

    // VAT calculation
    const vatInput = document.querySelector('#vat');
    const vatRate = vatInput ? parseFloat(vatInput.value) / 100 : 0;

    const vatAmount = subtotal * vatRate;
    const total = subtotal + vatAmount;

    document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " " + currency;
    document.getElementById("vat_amount").textContent = vatAmount.toFixed(2) + " " + currency;
    document.getElementById("total").textContent = total.toFixed(2) + " " + currency;
  }

  // Events
  document.getElementById("invoiceTable").addEventListener("input", updateTotals);
  document.querySelector('#vat').addEventListener("input", updateTotals);

  const currencyEl = document.querySelector('#currency');
  if (currencyEl) {
      currencyEl.addEventListener("input", updateTotals);
  }

  document.getElementById("addRow").addEventListener("click", (e) => {
    e.preventDefault();
    rowCount++;
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md" type="text" name="extra.row.${rowCount}.description" placeholder="Description"></td>
      <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md" type="number" name="extra.row.${rowCount}.price" value="0" step="0.01" min="0"></td>
      <td><input class="w-full px-3 py-2 border border-gray-300 rounded-md" type="number" name="extra.row.${rowCount}.qty" value="1" step="1" min="0"></td>
      <td class="line-total">0.00</td>
    `;
    document.getElementById("invoiceBody").appendChild(newRow);
  });

  updateTotals();
})();
</script>
