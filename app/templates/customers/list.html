<div id="customer-container">
    <div id="customer-list"
        x-data="{
            selected: JSON.parse(localStorage.getItem('selectedCustomers') || '{}'),
            showSelect: JSON.parse(localStorage.getItem('showSelect') || 'true'),
            toggle(id) {
                this.selected[id] = !this.selected[id];
                localStorage.setItem('selectedCustomers', JSON.stringify(this.selected));
            },
            toggleSelect() {
                this.showSelect = !this.showSelect;
                localStorage.setItem('showSelect', JSON.stringify(this.showSelect));
            },
            getSelectedIds() {
                return Object.keys(this.selected)
                            .filter(id => this.selected[id])
                            .map(id => parseInt(id));
            }
        }"
    >

        <table class="table-auto w-full border">
            <thead>
                <tr>
                    <th class="px-2 py-1 border">ID</th>
                    <th class="px-2 py-1 border">Name</th>
                    <th class="px-2 py-1 border">Email</th>
                    <th class="px-2 py-1 border">Command</th>
                    <th class="px-2 py-1 border" x-show="showSelect">Select</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}?list=short"
                    hx-target="#customer-info"
                    hx-trigger="click"
                    class="cursor-pointer hover:bg-gray-100">

                    <td class="px-2 py-1 border">{{ customer.id }}</td>
                    <td class="px-2 py-1 border">{{ customer.first_name }} {{ customer.second_name }}</td>
                    <td class="px-2 py-1 border">{{ customer.email }}</td>

                    <td class="px-2 py-1 border text-center" 
                        @click.stop
                        >

                        <button 
                            hx-get="{{ url_for('customer_detail', customer_id=customer.id) }}"
                            hx-target="#customer-info"
                            hx-swap="innerHTML"
                        >
                            Edit
                        </button>                
                        <button 
                            hx-post="{{ url_for('customer_delete', customer_id=customer.id) }}"
                            hx-on="htmx:afterRequest: showPopup(event)"
                            hx-trigger="click"
                            hx-vals='{"refreshTarget": "#customer-list"}'
                        >
                            Delete
                        </button>
                    </td>

                    <td class="px-2 py-1 border text-center" 
                        x-show="showSelect" 
                        @click.stop>
                        <input type="checkbox"
                            :checked="selected[{{ customer.id }}] || false"
                            @change="toggle({{ customer.id }})">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="mt-2 flex gap-2">
            <button hx-get="/customers/new"
                    hx-target="#customer-list"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                New Customer
            </button>

            <button @click="toggleSelect()"
                    class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                    
                Toggle Select Column
            </button>

        <button
                :hx-vals="JSON.stringify({ selected_ids: getSelectedIds() })"
                hx-post="/calls/dashboard"
                hx-ext="json-enc"
                hx-target="#customer-container"
                class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">
                Load Selected Customers
            </button>

        </div>

    <!-- Debug output in the page -->
        <div class="mt-3 p-2 border bg-gray-50 text-sm">
            Selected IDs: <span x-text="getSelectedIds()"></span>
        </div>


        
    <div id="customer-info"></div>
        
    </div>

</div>

<!-- Popup div -->
<div id="popup" 
     style="display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%); 
            background:#333; color:#fff; padding:10px 20px; border-radius:5px; z-index:1000;">
</div>


<script>
function showPopup(evt) {
    let response = evt.detail.xhr.responseText;
    try {
        let data = JSON.parse(response);

        // Show popup
        let popup = document.getElementById('popup');
        popup.innerText = data.detail;
        popup.style.display = 'block';

        setTimeout(() => popup.style.display = 'none', 2000);

        // Refresh customer list via HTMX
        let containerSelector = evt.detail.elt.getAttribute('hx-vals') 
                                ? JSON.parse(evt.detail.elt.getAttribute('hx-vals')).refreshTarget
                                : "#customer-list";
        htmx.ajax('GET', "{{ url_for('customers_list') }}", {target: containerSelector});
        
    } catch(err) {
        console.error("Invalid JSON from server:", response);
    }
}
</script>

<script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
