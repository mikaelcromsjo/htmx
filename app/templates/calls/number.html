<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Customer</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .btn {
            padding: 15px 25px;
            font-size: 1.2em;
            margin: 10px 5px;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Call Customer</h1>

    <p><span id="name">...</span></p>
    <p><span id="number">...</span></p>

    <div class="d-flex justify-content-center">
        <!-- Call Button -->
        <a id="call_href" href="">
            <button class="btn btn-primary" onclick="call()">Call</button>
        </a>


        <!-- SMS Button 
        <a id="text_href" href="">
            <button class="btn btn-success">Send SMS</button>
        </a>
        -->
    </div>
</div>

<script>

let ws;
let wsToken;

// Get elements using querySelector
const name = document.querySelector("#name");
const number = document.querySelector("#number");
const call_href = document.querySelector("#call_href");
const text_href = document.querySelector("#text_href");

async function fetchToken() {
    const res = await fetch(`https://${location.host}/get-ws-token`, {
        credentials: "include"
    });
    const data = await res.json();
    wsToken = data.ws_token;
}

async function connectWS() {
    await fetchToken();

    ws = new WebSocket(`wss://${location.host}/calls/ws?token=${wsToken}`);

    ws.onopen = () => console.log("WebSocket connected!");
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("Recieved", data)
        if(data.name){
            name.textContent = data.name;
            number.textContent = data.number;
            call_href.href = "tel:" + data.number;
//            text_href.href = "sms:" + data.number + "?body=Hej!";
        }
    };

    ws.onclose = async () => {
        console.log("WebSocket closed. Reconnecting...");
        // Wait a second before reconnect
        setTimeout(connectWS, 1000);
    };

    // Send ping messages every x seconds
    setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "ping" }));
        }
    }, 10000);
}


// Send variable on each click
function call() {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.log("WebSocket not connected yet");
        return;
    }

    const call_id = Math.random(); 
    console.log("Sending Call");

    ws.send(JSON.stringify({ call: true }));
}

// Start automatically
connectWS();

    



</script>

</body>
</html>
